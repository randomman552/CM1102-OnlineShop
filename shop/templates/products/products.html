{% extends 'layout.html' %}
{% from 'products/macros.html' import rating %}

{% block head %}
    <title>Products</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/products.css') }}">
    <script defer type="text/javascript" src="{{ url_for('static', filename='js/dropdown.js') }}"></script>
    <script defer type="text/javascript">
        /** 
         * This function is used to change the url depending on the selected sort and order options.
         * @param {string} sort The option to change the sort variable to.
         * @param {string} order The option to change the order variable to.
         */
        function setSort(sort, order){
            //Get the current location as a string
            let curLocation = window.location.toString();

            //These options lists are used to make it easier to edit the variables in the url
            //Using the loops below
            let sort_options = [
                "rating",
                "price",
                "no.ratings"
            ];
            let order_options =  [
                "asc",
                "desc"
            ];
            
            //For each sort option, run a replace operation (this ensures we replace any option present)
            sort_options.forEach(element => {
                //Dont bother replacing an element if it is the same as the desired option
                if (element != sort){
                    curLocation = curLocation.replace(`sort=${element}`, `sort=${sort}`);
                }
            });

            //For each order option, run a replace operation
            order_options.forEach(element => {
                //Dont bother replacing an element if it is the same as the desired option
                if (element != order){
                    curLocation = curLocation.replace(`order=${element}`, `order=${order}`);
                }
            });

            //Redirect the user to the new url
            window.location = curLocation
        }
    </script>
{% endblock %}

{% block content %}
    <div class="container">
        <form method="GET" class="container filters" action="" novalidate autocomplete="off">
            <div>
                <h2>Filters:</h2>
                <button value="submit">Filter</button>
            </div>
        </form>
        <div class="container products">
            <div class="container controls">
                <!-- Sort selection dropdown -->
                <div class="dropdown-container" style="flex-basis: initial;">
                    <label class="dropdown-label" for="sort-by">Sort By:</label>
                    <div id="sort-by" class="dropdown hidden" onclick="toggleDropdown('sort-by')">
                        <span class="dropdown title">
                            {% if request.args['sort'] != "none" %}
                                {{ request.args['sort'] }} - {{ request.args['order'] }} 
                            {% else %}
                                none
                            {% endif %}
                        </span>
                        <span class="dropdown arrow"><img src="{{ url_for('static', filename='icons/angle.svg') }}"></span>
                        <div id="sort-by content" class="dropdown content">
                            <a onclick="setSort('price', 'asc')">price - ascending (low - high)</a>
                            <a onclick="setSort('price', 'desc')">price - descending (high - low)</a>
                            <a onclick="setSort('rating', 'desc')">rating - descending (high - low)</a>
                            <a onclick="setSort('no.ratings', 'desc')">no.ratings - descending (high - low)</a>
                        </div>
                    </div>
                </div>
                <div>
                    View:&#32;
                    <button onclick="window.location = window.location.toString().replace('view=list', 'view=grid');">Grid</button>
                    <button onclick="window.location = window.location.toString().replace('view=grid', 'view=list');">List</button>
                </div>
            </div>
            {% if products|length > 0 %}
                {% for i in range(products|length) %}
                    {% if products[i].public or mode == "edit" %}
                        <product class="{{ session['view'] }}" onclick="window.location = '/products/{{ products[i].ID }}'">
                            <div class="info-container grid novis {% if session['view'] == 'list' %} reverse {% endif %}">
                                <div class="info-container {{ session['view'] }} image">
                                    {% if pictures[i]|length > 0 %}
                                        <img src="{{ url_for('static', filename=pictures[i][0].URL) }}" alt="Image of Product">
                                    {% else %}
                                        <img src="{{ url_for('static', filename='products/default.png') }}" alt="No Image">
                                    {% endif %}
                                </div>
                                <div class="info-container {{ session['view'] }} name">
                                    {{ products[i].name }}
                                </div>
                            </div>
                            <div class="info-container {{ session['view'] }} reverse">
                                <div class="info-container {{ session['view'] }} description">
                                        {% set overview = products[i].information['overview'] -%}
                                        {%- if overview|length > 0 -%}
                                            <ul>
                                                {%- for item in overview -%}
                                                    <li>{{ item }}</li>
                                                {%- endfor -%}
                                            </ul>
                                        {%- else -%}
                                            {# if the product description is longer than 300 characters, limit it to 300 characters #}
                                            {% if products[i].description|length > 300 %}
                                                {{ products[i].description[:300] -}} {{- "..." }}
                                            {# Otherwise display the whole description #}
                                            {% else %}
                                                {{ products[i].description }}
                                            {% endif %}
                                        {%- endif %}
                                </div>
                                <div class="info-container grid novis">
                                    <div class="info-container {{ session['view'] }} price">
                                        {{ products[i].price }}
                                    </div>
                                    {{ rating(ratings[i][0], ratings[i][1]) }}
                                </div>
                            </div>
                        </product>
                    {% endif %}
                {% endfor %}
            {% else %}
                <h1>There are no products that match your search.</h1>
            {% endif %}
        </div>
    </div>
{% endblock %}